<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/css/reset.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.css">
    <script type="text/js" src="https://cdnjs.com/libraries/chart.js"></script>
    <script src="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.js"></script>
  </head>
  <body class="mixpanel-platform-body">
    <canvas id="myChart" width="400" height="400"></canvas>
    <script>
      var iOSParams = {
        from_date:'2016-02-01',
        to_date:'2016-03-01',
        limit:200,
        where:'(properties["$os"] == "iPhone iOS" or properties["$os"] == "iPhone OS")',
        interval:30
      }
      
      var androidParams = {
        from_date:'2016-02-01',
        to_date:'2016-03-01',
        limit:200,
        where:'(properties["$os"] == "Android")',
        interval:30
      }
      
      var steps = [{"event":"app-install"},{"event":"App Opened"},{"event":"6 Month Recurring"},{"event":"Payment Started"},{"event":"Payment Completed"},{"event":"Sponsor Subscription Completed"}]
      var iOSFunnel = steps
      iOSFunnel.push(iOSParams)
      var androidFunnel = steps
      androidFunnel.push(androidParams)
      
      var iOS = MP.api.funnel.apply(MP.api, iOSFunnel)
      var android = MP.api.funnel.apply(MP.api, androidFunnel)
      var resultTransform = function (data){
        debugger
        return data
      }
      
      $.when(iOS, android).done(function(iOS, android){
        var iOSData = resultTransform(iOS)
        var androidData = resultTransform(android)
        var ctx = document.getElementById("myChart").getContext("2d");
        var myBarChart = new Chart(ctx).Bar(data, options);
        var labels =[]
        _.each(steps, function(el, idx){
          labels.push(el.event)
        })
        
        var data = {
          labels: labels,
          datasets: [
            {
              label: "iOS",
              fillColor: "rgba(220,220,220,0.5)",
              strokeColor: "rgba(220,220,220,0.8)",
              highlightFill: "rgba(220,220,220,0.75)",
              highlightStroke: "rgba(220,220,220,1)",
              data: [65, 59, 80, 81, 56, 55, 40]
          },
          {
              label: "Android",
              fillColor: "rgba(151,187,205,0.5)",
              strokeColor: "rgba(151,187,205,0.8)",
              highlightFill: "rgba(151,187,205,0.75)",
              highlightStroke: "rgba(151,187,205,1)",
              data: [28, 48, 40, 19, 86, 27, 90]
            }
          ]
        };
      })
      
    </script>
  </body>
</html>
